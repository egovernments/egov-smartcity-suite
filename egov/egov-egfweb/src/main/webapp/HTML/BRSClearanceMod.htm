#-------------------------------------------------------------------------------
# eGov suite of products aim to improve the internal efficiency,transparency, 
#      accountability and the service delivery of the government  organizations.
#   
#       Copyright (C) <2015>  eGovernments Foundation
#   
#       The updated version of eGov suite of products as by eGovernments Foundation 
#       is available at http://www.egovernments.org
#   
#       This program is free software: you can redistribute it and/or modify
#       it under the terms of the GNU General Public License as published by
#       the Free Software Foundation, either version 3 of the License, or
#       any later version.
#   
#       This program is distributed in the hope that it will be useful,
#       but WITHOUT ANY WARRANTY; without even the implied warranty of
#       MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#       GNU General Public License for more details.
#   
#       You should have received a copy of the GNU General Public License
#       along with this program. If not, see http://www.gnu.org/licenses/ or 
#       http://www.gnu.org/licenses/gpl.html .
#   
#       In addition to the terms of the GPL license to be adhered to in using this
#       program, the following additional terms are to be complied with:
#   
#   	1) All versions of this program, verbatim or modified must carry this 
#   	   Legal Notice.
#   
#   	2) Any misrepresentation of the origin of the material is prohibited. It 
#   	   is required that all modified versions of this material be marked in 
#   	   reasonable ways as different from the original version.
#   
#   	3) This license does not grant any rights to any user of the program 
#   	   with regards to rights under trademark law for use of the trade names 
#   	   or trademarks of eGovernments Foundation.
#   
#     In case of any queries, you can reach eGovernments Foundation at contact@egovernments.org.
#-------------------------------------------------------------------------------
<!doctype html public "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>

<script language="javascript">
	window.dataRetreived=false;
	function onBodyLoad()
	{
		PageValidator.addCalendars();
		PageManager.ListService.callListService();

		bySubmit = PageManager.DataService.getQueryField('bySubmit');
		if(bySubmit != null && bySubmit == 'Y'){
			getAccountNumbers();
			searchTrans('1');
		}
	}
	function beforeRefreshPage(dc){
	}
	function afterRefreshPage(dc)
	{
		var i, row, table, t, tableObj, divReconcile, gridbankentry, gridaccbalance;

		tableObj = dc.grids['gridBankReconciliation'];
			if(!tableObj)
			return;

		if(tableObj.length > 1){
			document.getElementById('gridSubmit').style.visibility = 'visible';
			document.getElementById('gridBankReconciliation').style.visibility = 'visible';
		}else{
			document.getElementById('gridSubmit').style.visibility = 'hidden';
			document.getElementById('gridBankReconciliation').style.visibility = 'hidden';
			alert("No Records");
		}
		for(i=1; i<tableObj.length; i++)
		{
			if(tableObj.length == 2)
				obj = document.bankReconciliation.bankReconciliation_ID;
			else
				obj = document.bankReconciliation.bankReconciliation_ID[i-1];

			row=PageManager.DataService.getRow(obj);
			table = document.getElementById('gridBankReconciliation');
			t=PageManager.DataService.getControlInBranch(table.rows[row.rowIndex].cells[0],"bankReconciliation_srNo");
			t.innerHTML = i;
			t=PageManager.DataService.getControlInBranch(table.rows[row.rowIndex].cells[6],"bankReconciliation_updatedDate");
			//t.innerHTML = '<input name=clearanceDate id=clearanceDate maxlength=11 size=12 exilDataType=exilPastDate onMouseDown=fillDate(this)>&nbsp;';
			t.innerHTML = '<input name=clearanceDate id=clearanceDate maxlength=11 size=12 exilDataType=exilPastDate><A onclick=fillDate(this) tabIndex=-1 href=#><IMG tabIndex=-1 src=../images/calendar.gif width=22 height=22></A>&nbsp;';

			t=PageManager.DataService.getControlInBranch(table.rows[row.rowIndex].cells[1],"bankReconciliation_transactionDate");
			formatDates(t);
			t=PageManager.DataService.getControlInBranch(table.rows[row.rowIndex],"bankReconciliation_clearanceDate");
			formatDates(t);
		}

		PageManager.DataService.removeQueryField('bankAccount_id');
		PageManager.DataService.removeQueryField('startDate');
		PageManager.DataService.removeQueryField('endDate');
		PageManager.DataService.removeQueryField('bySubmit');
		var startDate=document.getElementById('startDate').value;
		var endDate=document.getElementById('endDate').value;

			if(startDate && startDate.length!=0)
					{
					var startDate=dc.values['startDate'];
					startDate=formatDateToDDMMYYYY4(startDate);
					document.getElementById('startDate').value=startDate;
					}
					if(endDate && endDate.length!=0)
					{
					var endDate=dc.values['endDate'];
					endDate=formatDateToDDMMYYYY4(endDate);
					document.getElementById('endDate').value=endDate;
					}
	}
	function formatDates(ctrl)
	{
		ctrl.innerHTML=formatDate(ctrl.innerHTML.substring(0, 10));
		/*var months = ["NA","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

		var date = ctrl.innerHTML.substring(0, 10);
		if( !(date == null || date == '') ){
			var array = date.split("-");
			ctrl.innerHTML = array[2] + '-' + months[parseInt(array[1], 10)] + '-' + array[0];
		}*/
	}
	//return values
	 // 0 means dt1=dt2, -1 means dt1<dt2,  1 means dt1>dt2
	 function compareDate(dt1, dt2){
		var d1, m1, y1, d2, m2, y2, ret;
		dt1 = dt1.split('-');
		dt2 = dt2.split('-');

		ret = (eval(dt2[2])>eval(dt1[2])) ? 1 : (eval(dt2[2])<eval(dt1[2])) ? -1 : (eval(dt2[1])>eval(dt1[1])) ? 1 : (eval(dt2[1])<eval(dt1[1])) ? -1 : (eval(dt2[0])>eval(dt1[0])) ? 1 : (eval(dt2[0])<eval(dt1[0])) ? -1 : 0 ;
		return ret;
	}
	function fillDate(obj){
		/*PageValidator.showCalendar('selectedDate');
		obj.value = document.getElementById('selectedDate').value;
		document.getElementById('selectedDate').value = "";*/
		PageValidator.showCalendar('selectedDate');
		row = PageManager.DataService.getRow(obj);
		table = document.getElementById('gridBankReconciliation');
		ctrl = PageManager.DataService.getControlInBranch(table.rows[row.rowIndex], 'clearanceDate');
		ctrl.value = document.getElementById('selectedDate').value;
		document.getElementById('selectedDate').value = "";
	}

	function ButtonPress(name)
	{
		var flag=false, transDate, clearDate, ctrl, table = document.getElementById('gridBankReconciliation');
		if(table == null) return;

		for(var i=1; i<table.rows.length; i++){
			ctrl = PageManager.DataService.getControlInBranch(table.rows[i], 'bankReconciliation_transactionDate');
			transDate = formatDate_DDMMYYYY(ctrl.innerHTML);
			ctrl = PageManager.DataService.getControlInBranch(table.rows[i], 'clearanceDate');

			if(ctrl.value != ''){
				flag = true;
				clearDate = formatDate_DDMMYYYY1(ctrl.value);

				if(compareDate(clearDate, transDate) == 1){
					alert('clearance date can not be less than transaction date, check row no. ' + i);
					return false;
				}
			}
		}
		if(!flag) {
			alert('no clearance date to modify');
			return false;
		}

		if(!PageValidator.validateForm()) return false;

		PageManager.DataService.setQueryField('bySubmit', 'Y');

		//Same service "reconcile" is used for clearance date and modification of clearace date.
		PageManager.UpdateService.submitForm('reconcile');
	}
	function formatDate_DDMMYYYY(date){
		var newDate, mon;
			date = date.split('-');
			switch(date[1]){
				case 'Jan': mon = '01'; break;
				case 'Feb': mon = '02'; break;
				case 'Mar': mon = '03'; break;
				case 'Apr': mon = '04'; break;
				case 'May': mon = '05'; break;
				case 'Jun': mon = '06'; break;
				case 'Jul': mon = '07'; break;
				case 'Aug': mon = '08'; break;
				case 'Sep': mon = '09'; break;
				case 'Oct': mon = '10'; break;
				case 'Nov': mon = '11'; break;
				case 'Dec': mon = '12'; break;
				default: mon = 'not valid';
			}
			if(mon == 'not valid'){
				alert('month is not valid, please chaeck.');
				return false;
			}
			newDate = date[0] + '-' + mon + '-' + date[2];
			return newDate;
	}
	function formatDate_DDMMYYYY1(date){
		var newDate, mon;
			date = date.split('/');
			newDate = date[0] + '-' + mon + '-' + date[2];
			return newDate;
	}
	function searchTrans(bySubmit){
		if(bySubmit == '1'){
			if(PageManager.DataService.getQueryField('bankAccount_id') != null || PageManager.DataService.getQueryField('bankAccount_id') != '')
				PageManager.DataService.setQueryField('bankAccount_id', PageManager.DataService.getQueryField('bankAccount_id'));
			if(PageManager.DataService.getQueryField('startDate') != null || PageManager.DataService.getQueryField('startDate') != '')
				PageManager.DataService.setQueryField('startDate', PageManager.DataService.getQueryField('startDate'));
			if(PageManager.DataService.getQueryField('endDate') != null || PageManager.DataService.getQueryField('endDate') != '')
				PageManager.DataService.setQueryField('endDate', PageManager.DataService.getQueryField('endDate'));
		}else{
			if(!PageValidator.validateForm()) return false;
			obj = document.getElementById('bankAccount_id');
			accNumId = obj.options[obj.selectedIndex].value;
			PageManager.DataService.setQueryField('bankAccount_id', accNumId);
			startDate = document.getElementById('startDate').value;
			endDate = document.getElementById('endDate').value;
			if(startDate != '')
				PageManager.DataService.setQueryField('startDate', formatDate5(startDate));
			if(endDate != '')
				PageManager.DataService.setQueryField('endDate', formatDate5(endDate));
		}
		PageManager.DataService.callDataService('reconciledTransactions');
	}
	function getAccountNumbers()
	{
		document.getElementById('gridBankReconciliation').style.visibility = 'hidden';
		document.getElementById('gridSubmit').style.visibility = 'hidden';

		var branchid;
		var ctrl = document.getElementById('bank_id');
		if(PageManager.DataService.getQueryField('bank_id') != null && PageManager.DataService.getQueryField('bank_id') != ""){
			branchid = PageManager.DataService.getQueryField('bank_id');
			PageManager.DataService.removeQueryField('bank_id');
		}else{
			branchid = ctrl.options[ctrl.selectedIndex].value;
		}

		var a = Array(2);
		a = branchid.split('-');
		branchid = a[1];

		var obj = document.getElementById('bankAccount_id');
		obj.setAttribute('exilListSource','accountList');

		PageManager.DataService.setQueryField('branchId',branchid);
		PageManager.DataService.callDataService('accNumber');
	}

	function afterUpdateService(){
		var accNumId='', bankId='', sdt = '', edt='', obj;

		obj = document.getElementById('bankAccount_id');
		if(obj.selectedIndex > 0)
			accNumId = obj.options[obj.selectedIndex].value;

		obj = document.getElementById('bank_id');
		if(obj.selectedIndex > 0)
			bankId = obj.options[obj.selectedIndex].value;

		sdt = document.getElementById('startDate').value;
		edt = document.getElementById('endDate').value;
		window.location = "BRSClearanceMod.htm?bySubmit=Y&bank_id="+bankId+"&bankAccount_id="+accNumId+"&startDate="+sdt+"&endDate="+edt;
	}
</script>

</head>
<body onLoad="onBodyLoad()" onKeyDown ="CloseWindow(event);" bgcolor="#ffffff" bottommargin="0" topmargin="0" rightmargin="0" leftmargin="0" marginheight="0" marginwidth="0">
<form name="bankReconciliation">
	<table width="100%" border=0 cellpadding="0" cellspacing="0"><!------------Content begins here ------------------>
			<tr>
			<td valign="top" class="normaltext">
						<table width="100%" border=0 cellpadding="3" cellspacing="0">
							<tr>
								<td class="rowheader" colspan="4" width="884"><span class="headerwhite2">BR Clearance Date Update</span></td>
							</tr>
							<tr class="row2">
								<td width="20%"><DIV class=normaltext align=right>Bank And Branch<span class="leadon">*</span></DIV> </td>
								<td width="30%" align="left"><select name="bank_id" id="bank_id" class="fieldinput" onChange="getAccountNumbers()" exilListSource="bankAndBranch" exilMustEnter="true"></select></td>
								<td width="20%"><DIV class=normaltext align=right>Account Number<span class="leadon">*</span></DIV> </td>
								<td width="30%" align="left"><select name="bankAccount_id" id="bankAccount_id" class="fieldinput" exilMustEnter="true"></select></td>
							</tr>
							<tr class="row1">
								<td><DIV class=normaltext align=right>Transaction&nbsp; Start Date</DIV>  </td>
								<td align="left"><input name="startDate" id="startDate" maxlength="11" size="12" onkeyup="DateFormat(this,this.value,event,false,'3')" exilDataType="exilPastDate" exilCalendar="true"></td>
								<td><DIV class=normaltext align=right>End
          Date</DIV> </td>
								<td align="left"><input name="endDate" id="endDate" maxlength="11" size="12" onkeyup="DateFormat(this,this.value,event,false,'3')" exilDataType="exilPastDate" exilCalendar="true"></td>
							</tr>
							<tr class="row2">
							   <td height="25" colspan="4" valign="bottom" class="smalltext"><p class="smalltext">
									  &nbsp;</p>
							   </td>
							</tr>
							<tr class="row2">
								<td align=middle colspan=4>
									<table border="0" cellpadding="0" cellspacing="0">
										<tr>
											<td align="right"><IMG height=18 src="../images/Button_leftside.gif" width=7></td>
											<td bgcolor="#fe0000" valign="center" nowrap><A class=buttonprimary onclick=searchTrans(0) href="#">Search</A></td>
											<td><IMG height=18 src="../images/Button_rightside.gif" width=7></td>
											<td><IMG src="../images/spacer.gif" width=8></td>
										</tr>
										<tr>
											<td colspan="4">&nbsp;</td>
										</tr>
									</table>
								</td>
							</tr>

						</table>
				</td>
		  </tr><!------------ Content ends here ------------------>
							<tr>
								<td><!--
									<table width ="100%" height=25 border=0 cellpadding="0" cellspacing="0" id="gridAccountBalance" name="gridAccountBalance">
										<tr class="row1" name="">
											<td width="88%" class="normaltext" colspan=2><div align="right">Account Balance&nbsp;&nbsp;</div></td>
											<td width="12%" class="normaltext"><div align="left" id=bankReconciliation_accountBalance name="bankReconciliation_accountBalance">&nbsp;</div></td>
										</tr>
									</table>
									-->
									<DIV id="divReconcile" name="divReconcile"  style="visibility: hidden">
									<table width ="80%" border=0 align="center" cellpadding="6" cellspacing="0" id="gridBankReconciliation" name="gridBankReconciliation" height=40>
										<tr class="rowheader" style="HEIGHT: 22px">
											<td class="columnheader" width="4%"><div align="center">Sr&nbsp;No</div></td>
											<td class="columnheader" width="16%"><div align="left">Transaction&nbsp;Date</div></td>
											<td class="columnheader" width="16%"><div align="left">Cheque&nbsp;Number</div></td>
											<td class="columnheader" width="16%"><div align="right">Debit</div></td>
											<td class="columnheader" width="16%"><div align="right">Credit</div></td>
											<td class="columnheader" width="16%">Clearance&nbsp;Date<DIV></DIV></td>
											<td class="columnheader" width="16%"><div align="center" name="HdrCCDate" id="HdrCCDate">Modify&nbsp;Date</div><input type="hidden" size=1 name="selectedDate" id="selectedDate"></td></tr>
										<tr class="row2">
											<td class="normaltext">
												<div align="right" id=bankReconciliation_srNo name="bankReconciliation_srNo">&nbsp;</div>
												<input type="hidden" name="bankReconciliation_ID" id="bankReconciliation_ID">
											</td>
											<td class="normaltext"><div align="left" name="bankReconciliation_transactionDate" id="bankReconciliation_transactionDate"></div> </td>
											<td class="normaltext"><div align="left" name="bankReconciliation_chequeNumber"></div> </td>
											<td class="normaltext"><div align="right" name="bankReconciliation_debit"></div> </td>
											<td class="normaltext"><div align="right" name="bankReconciliation_credit"></div> </td>
											<td class="normaltext"><div align="right" name="bankReconciliation_clearanceDate" id="bankReconciliation_clearanceDate">&nbsp;</div></td>
											<td class="normaltext"><div align="right" name="bankReconciliation_updatedDate"><input name="clearanceDate" id="clearanceDate" maxlength="11" size="12" onkeyup="DateFormat(this,this.value,event,false,'3')" exilDataType="exilPastDate"><A onclick="fillDate(this)" tabIndex=-1 href=#><IMG tabIndex=-1 src="../images/calendar.gif" width="22" height="22"></A></div></td>
										</tr></table>
									<table width="100%" border=0 cellpadding="0" cellspacing="0" id=TABLE1>
										<tr class="row1"><td colspan=6>&nbsp;</td></tr>
										<tr class="row1">
											<td align=middle>
												<table border="0" cellpadding="0" cellspacing="0" name="gridSubmit" id="gridSubmit" style="VISIBILITY: hidden">
													<tr class="row1">
														<td align="right"><IMG id=IMG1 height=18 src="../images/Button_leftside.gif" width=7 ></td>
														<td bgcolor="#fe0000" valign="center" nowrap><A class=buttonprimary onclick=ButtonPress('saveclose') href="#">Submit</A></td>
														<td><IMG height=18 src="../images/Button_rightside.gif" width=7></td>
														<td><IMG src="../images/spacer.gif" width=8></td>
														<td align="right"><IMG height=18 src="../images/Button_second_leftside.gif" width=6></td>
														<td bgcolor="#ffffff" valign="center" nowrap background="../images/Button_second_middle.gif"><A class=buttonsecondary href="Home.htm">Close</A></td>
														<td><IMG height=18 src="../images/Button_second_rightside.gif" width=6></td>
													</tr>
												</table>
											</td>
										</tr>


									</table></DIV>
								<td></td>
										</tr>
									</table>
</form>
</body>
</html>
